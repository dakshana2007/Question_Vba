Sub FormatPreserveEquationsAndImages_Optimized()
    Dim doc As Document
    Dim para As Paragraph
    Dim rng As Range
    Dim omathRange As Range
    Dim skipFormatting As Boolean
    Dim omath As OMath
    Dim eqRanges() As Range
    Dim i As Long

    Set doc = ActiveDocument
    Application.ScreenUpdating = False

    ' Cache all equation ranges
    ReDim eqRanges(1 To doc.OMaths.Count)
    For i = 1 To doc.OMaths.Count
        Set eqRanges(i) = doc.OMaths(i).Range
    Next i

    ' Loop through paragraphs
    For Each para In doc.Paragraphs
        Set rng = para.Range
        skipFormatting = False

        ' Skip if paragraph contains an equation
        For i = LBound(eqRanges) To UBound(eqRanges)
            If Not (rng.End < eqRanges(i).Start Or rng.Start > eqRanges(i).End) Then
                skipFormatting = True
                Exit For
            End If
        Next i

        ' Skip if paragraph contains inline image
        If rng.InlineShapes.Count > 0 Then
            skipFormatting = True
        End If

        ' Apply paragraph spacing only if no equation/image
        If Not skipFormatting Then
            With para.Format
                .LineSpacingRule = wdLineSpaceExactly
                .LineSpacing = 13
                .SpaceBefore = 1
                .SpaceAfter = 2
            End With
        End If

        ' Apply font in bulk by language
        Set rng = para.Range
        For i = 1 To rng.Words.Count
            With rng.Words(i)
                If Len(Trim(.Text)) > 0 Then
                    Dim ch As String
                    ch = Left$(Trim(.Text), 1)
                    Dim code As Long
                    code = AscW(ch)
                    If code >= &H0900 And code <= &H097F Then
                        .Font.Name = "Mangal"
                    Else
                        .Font.Name = "Bookman Old Style"
                    End If
                End If
            End With
        Next i
    Next para

    Application.ScreenUpdating = True
    MsgBox "âœ… Formatting applied successfully.", vbInformation
End Sub
