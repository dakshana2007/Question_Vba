Sub FormatPreserveEquationsAndImages()
    Dim doc As Document
    Dim para As Paragraph
    Dim word As Range
    Dim firstChar As String
    Dim code As Long
    Dim rng As Range
    Dim hasEquation As Boolean
    Dim hasInlineShape As Boolean
    Dim omath As omath
    Dim i As Long

    Set doc = ActiveDocument
    Application.ScreenUpdating = False

    ' Step 1: Loop through all paragraphs
    For Each para In doc.Paragraphs
        Set rng = para.Range
        hasEquation = False
        hasInlineShape = False

        ' Check for equations
        For i = 1 To doc.OMaths.Count
            If Not (rng.End < doc.OMaths(i).Range.Start Or rng.Start > doc.OMaths(i).Range.End) Then
                hasEquation = True
                Exit For
            End If
        Next i

        ' Check for inline images
        For i = 1 To rng.InlineShapes.Count
            If Not rng.InlineShapes(i) Is Nothing Then
                hasInlineShape = True
                Exit For
            End If
        Next i

        ' Only apply line spacing if there's no equation or image
        If Not hasEquation And Not hasInlineShape Then
            With para.Format
                .LineSpacingRule = wdLineSpaceExactly
                .LineSpacing = 13
                .SpaceBefore = 1
                .SpaceAfter = 2
            End With
        End If

        ' Apply fonts to each word
        For Each word In rng.Words
            firstChar = Trim$(Left$(word.Text, 1))
            If Len(firstChar) > 0 Then
                code = AscW(firstChar)
                If code >= &H900 And code <= &H97F Then
                    word.Font.Name = "Mangal"
                ElseIf code >= 32 Then
                    word.Font.Name = "Bookman Old Style"
                End If
            End If
        Next word
    Next para

    Application.ScreenUpdating = True
    MsgBox "? Formatting applied. Equations and images preserved.", vbInformation
End Sub

